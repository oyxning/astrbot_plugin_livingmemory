name: è‡ªåŠ¨æ·»åŠ åˆ°é¡¹ç›®çœ‹æ¿

on:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, labeled]

jobs:
  add-to-project:
    runs-on: ubuntu-latest

    # è¿‡æ»¤æ¡ä»¶ï¼šåªå¤„ç†å¸¦æŒ‡å®šæ ‡ç­¾çš„ Issue æˆ– PR
    if: |
      contains(github.event.issue.labels.*.name, 'enhancement') ||
      contains(github.event.issue.labels.*.name, 'feature') ||
      contains(github.event.pull_request.labels.*.name, 'enhancement') ||
      contains(github.event.pull_request.labels.*.name, 'feature')

    steps:
      - name: æ·»åŠ åˆ°é¡¹ç›®å¹¶ç§»åŠ¨åˆ° Todo åˆ—
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_TOKEN }}
          script: |
            const CONFIG = {
              organization: 'lxfight-s-Astrbot-Plugins',  
              projectNumber: 1,                            
              statusFieldName: 'No Status',
              targetStatus: 'Todo',
            };

            // 1. è‡ªåŠ¨è¯†åˆ«æ˜¯ Issue è¿˜æ˜¯ PR
            const contentId = context.payload.issue?.node_id || context.payload.pull_request?.node_id;
            const number = context.payload.issue?.number || context.payload.pull_request?.number;
            const type = context.payload.issue ? 'Issue' : 'PR';
            const title = context.payload.issue?.title || context.payload.pull_request?.title;

            console.log(`ğŸ“‹ å¤„ç† ${type} #${number}: ${title}`);

            try {
              // 2. è·å–é¡¹ç›®ä¿¡æ¯
              console.log('ğŸ” æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯...');
              const projectQuery = `
                query($org: String!, $number: Int!) {
                  organization(login: $org) {
                    projectV2(number: $number) {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectData = await github.graphql(projectQuery, {
                org: CONFIG.organization,
                number: CONFIG.projectNumber
              });
              
              const project = projectData.organization.projectV2;
              console.log(`âœ… æ‰¾åˆ°é¡¹ç›®: "${project.title}" (ID: ${project.id})`);
              
              // 3. æŸ¥æ‰¾çŠ¶æ€å­—æ®µ
              const statusField = project.fields.nodes.find(
                field => field.name === CONFIG.statusFieldName
              );
              
              if (!statusField) {
                const availableFields = project.fields.nodes.map(f => f.name).join(', ');
                throw new Error(
                  `âŒ æœªæ‰¾åˆ°å­—æ®µ "${CONFIG.statusFieldName}"ã€‚å¯ç”¨å­—æ®µ: ${availableFields}`
                );
              }
              
              console.log(`âœ… æ‰¾åˆ°çŠ¶æ€å­—æ®µ: "${statusField.name}"`);
              
              // 4. æŸ¥æ‰¾ç›®æ ‡çŠ¶æ€é€‰é¡¹
              const availableStatuses = statusField.options.map(opt => opt.name);
              console.log(`ğŸ“‹ å¯ç”¨çŠ¶æ€: ${availableStatuses.join(', ')}`);
              
              const todoOption = statusField.options.find(
                opt => opt.name === CONFIG.targetStatus
              );
              
              if (!todoOption) {
                throw new Error(
                  `âŒ æœªæ‰¾åˆ°çŠ¶æ€ "${CONFIG.targetStatus}"ã€‚å¯ç”¨çŠ¶æ€: ${availableStatuses.join(', ')}`
                );
              }
              
              console.log(`âœ… ç›®æ ‡çŠ¶æ€: "${todoOption.name}"`);
              
              // 5. æ·»åŠ åˆ°é¡¹ç›®
              console.log(`ğŸ“Œ æ·»åŠ  ${type} åˆ°é¡¹ç›®...`);
              const addMutation = `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `;
              
              const addResult = await github.graphql(addMutation, {
                projectId: project.id,
                contentId: contentId
              });
              
              const itemId = addResult.addProjectV2ItemById.item.id;
              console.log(`âœ… å·²æ·»åŠ åˆ°é¡¹ç›® (Item ID: ${itemId})`);
              
              // 6. è®¾ç½®çŠ¶æ€
              console.log(`ğŸ”„ ç§»åŠ¨åˆ° "${todoOption.name}" åˆ—...`);
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { 
                        singleSelectOptionId: $optionId
                      }
                    }
                  ) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              await github.graphql(updateMutation, {
                projectId: project.id,
                itemId: itemId,
                fieldId: statusField.id,
                optionId: todoOption.id
              });
              
              // 7. æˆåŠŸæ€»ç»“
              console.log('');
              console.log('ğŸ‰ ============================================');
              console.log(`âœ… ${type} #${number} å·²æˆåŠŸæ·»åŠ åˆ°é¡¹ç›®`);
              console.log(`ğŸ“Š é¡¹ç›®: ${project.title}`);
              console.log(`ğŸ“ çŠ¶æ€: ${todoOption.name}`);
              console.log(`ğŸ”— æŸ¥çœ‹: https://github.com/orgs/${CONFIG.organization}/projects/${CONFIG.projectNumber}`);
              console.log('============================================');
              
            } catch (error) {
              // é”™è¯¯å¤„ç†
              console.error('');
              console.error('âŒ ============================================');
              console.error('é”™è¯¯è¯¦æƒ…:');
              console.error(error.message);
              console.error('============================================');
              console.error('');
              console.error('ğŸ’¡ æ•…éšœæ’æŸ¥å»ºè®®:');
              console.error('1. æ£€æŸ¥ Token æƒé™æ˜¯å¦åŒ…å«: project (read & write)');
              console.error('2. ç¡®è®¤é…ç½®ä¸­çš„ç»„ç»‡åç§°å’Œé¡¹ç›®ç¼–å·æ˜¯å¦æ­£ç¡®');
              console.error('3. ç¡®è®¤çŠ¶æ€å­—æ®µåç§°å’Œç›®æ ‡çŠ¶æ€åç§°æ˜¯å¦ä¸é¡¹ç›®çœ‹æ¿å®Œå…¨åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰');
              console.error('4. è®¿é—®é¡¹ç›®çœ‹æ¿æ£€æŸ¥å­—æ®µè®¾ç½®');
              console.error('');
              
              core.setFailed(error.message);
            }
